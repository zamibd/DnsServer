version: "3.9"

services:
  dns-server:
    container_name: dns-server
    hostname: dns-server
    image: technitium/dns-server:latest
    ports:
      - "5380:5380/tcp"   # Web console (HTTP)
      - "53443:53443/tcp" # Web console (HTTPS)
      - "53:53/udp"       # DNS service
      - "53:53/tcp"       # DNS service
      - "853:853/tcp"     # DNS-over-TLS
      - "853:853/udp"     # DNS-over-QUIC
      - "443:443/tcp"     # DNS-over-HTTPS (HTTP/1.1, HTTP/2)
      - "443:443/udp"     # DNS-over-HTTPS (HTTP/3)
    environment:
      - DNS_SERVER_DOMAIN=dns.bdtunnel.com
      - DNS_SERVER_ADMIN_PASSWORD_FILE=/run/secrets/dns_admin_password
      - DNS_SERVER_WEB_SERVICE_ENABLE_HTTPS=true
      - DNS_SERVER_WEB_SERVICE_USE_SELF_SIGNED_CERT=false
      - DNS_SERVER_WEB_SERVICE_TLS_CERTIFICATE_PATH=/etc/dns/tls/cert.pfx
      - DNS_SERVER_WEB_SERVICE_TLS_CERTIFICATE_PASSWORD_FILE=/run/secrets/dns_cert_password
      - DNS_SERVER_RECURSION=AllowOnlyForPrivateNetworks
      - DNS_SERVER_RECURSION_NETWORK_ACL=192.168.0.0/16,10.0.0.0/8,!0.0.0.0/0
      - DNS_SERVER_FORWARDERS=1.1.1.1,8.8.8.8
      - DNS_SERVER_FORWARDER_PROTOCOL=Udp
      - DNS_SERVER_ENABLE_BLOCKING=true
      - DNS_SERVER_LOG_USING_LOCAL_TIME=true
    volumes:
      - config:/etc/dns
      - ./tls:/etc/dns/tls:ro
    secrets:
      - dns_admin_password
      - dns_cert_password
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-fsS", "https://localhost:53443"]
      interval: 30s
      timeout: 10s
      retries: 3
    sysctls:
      net.ipv4.ip_local_port_range: "1024 65535"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

volumes:
  config:

secrets:
  dns_admin_password:
    file: ./secrets/dns_admin_password.txt
  dns_cert_password:
    file: ./secrets/dns_cert_password.txt
